<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Excel å·¥å–®è½‰æ›å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f8f9fa; }
    h1 { font-size: 22px; margin-bottom: 20px; }
    .upload-box { padding: 20px; border: 2px dashed #888; border-radius: 10px; background: #fff; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Excel å·¥å–®è½‰æ›å·¥å…·</h1>

  <div class="upload-box">
    <input type="file" id="upload" accept=".xlsx" />
    <p>è«‹ä¸Šå‚³ä¾†æºæª” (DefTicketExport...xlsx)</p>
  </div>

  <button id="download" style="display:none;">ä¸‹è¼‰æˆæœæª”</button>

  <script>
    document.getElementById("upload").addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        // è®€å–ä¾†æºæª”çš„ç¬¬ä¸€å€‹åˆ†é 
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        // éŠ·å”®ç›¸é—œå•é¡Œé—œéµå­—
        const keywords = ["(åŠ ç›Ÿ)è¾¦Açµ¦B", "ç›œè¾¦", "ç‰¹æ®Šèº«ä»½è¾¦ç†çˆ­è­°", "éŠ·å”®ç›¸é—œå•é¡Œ", "è¾¦é–€è™Ÿæ›ç¾é‡‘"];

        // åˆ†é ä¸€ï¼šä¾ X æ¬„(æ¥­å‹™å§“å)çµ±è¨ˆ
        let salesStats = {};
        jsonData.forEach(row => {
          const name = row["X"]?.toString().trim();
          const ai = row["AI"]?.toString().trim();

          if (!name) return;

          if (!salesStats[name]) {
            salesStats[name] = { total: 0, issue: 0 };
          }

          salesStats[name].total++;
          if (ai && keywords.some(k => ai.includes(k))) {
            salesStats[name].issue++;
          }
        });

        const ws1Data = Object.entries(salesStats).map(([name, obj]) => ({
          "æ¥­å‹™å§“å": name,
          "å·¥å–®ç¸½ç­†æ•¸": obj.total,
          "éŠ·å”®ç›¸é—œå•é¡Œä»¶æ•¸": obj.issue
        }));

        // åˆ†é äºŒï¼šä¾ AM æ¬„(é–€å¸‚ä»£ç¢¼+åç¨±)çµ±è¨ˆ
        let storeStats = {};
        jsonData.forEach(row => {
          let am = row["AM"]?.toString().trim();
          const ai = row["AI"]?.toString().trim();

          if (!am || am.length < 8) return;

          const code = am.substring(0, 7); // å‰7ç¢¼
          const name = am.substring(7).trim(); // å¾Œé¢åç¨±
          const key = code + " " + name;

          if (!storeStats[key]) {
            storeStats[key] = { code, name, total: 0, issue: 0 };
          }

          storeStats[key].total++;
          if (ai && keywords.some(k => ai.includes(k))) {
            storeStats[key].issue++;
          }
        });

        const ws2Data = Object.values(storeStats).map(obj => ({
          "7ä½æ•¸ä»£ç¢¼": obj.code,
          "åŠ ç›Ÿé–€å¸‚åç¨±": obj.name,
          "å·¥å–®ç¸½ç­†æ•¸": obj.total,
          "éŠ·å”®ç›¸é—œå•é¡Œä»¶æ•¸": obj.issue
        }));

        // === ç”¢ç”Ÿæˆæœæª” ===
        const wb = XLSX.utils.book_new();

        // Sheet1: æ¥­å‹™çµ±è¨ˆ
        const ws1 = XLSX.utils.json_to_sheet(ws1Data);
        XLSX.utils.book_append_sheet(wb, ws1, "æ¥­å‹™çµ±è¨ˆ");

        // Sheet2: é–€å¸‚çµ±è¨ˆ
        const ws2 = XLSX.utils.json_to_sheet(ws2Data);
        XLSX.utils.book_append_sheet(wb, ws2, "é–€å¸‚çµ±è¨ˆ");

        // ä¸‹è¼‰æŒ‰éˆ•
        document.getElementById("download").style.display = "inline-block";
        document.getElementById("download").onclick = function() {
          XLSX.writeFile(wb, "å·¥å–®ç›®æ¨™æª”.xlsx");
        };
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
