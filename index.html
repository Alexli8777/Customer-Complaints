<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Excel 工單轉換工具</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f8f9fa; }
    h1 { font-size: 22px; margin-bottom: 20px; }
    .upload-box { padding: 20px; border: 2px dashed #888; border-radius: 10px; background: #fff; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>📊 Excel 工單轉換工具</h1>

  <div class="upload-box">
    <input type="file" id="upload" accept=".xlsx" />
    <p>請上傳來源檔 (DefTicketExport...xlsx)</p>
  </div>

  <button id="download" style="display:none;">下載成果檔</button>

  <script>
    document.getElementById("upload").addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        // 預設讀取第一個工作表
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        // 統計 X 欄位 (業務姓名件數)
        let salesCount = {};
        jsonData.forEach(row => {
          const name = row["X"]?.toString().trim();
          if (name) {
            salesCount[name] = (salesCount[name] || 0) + 1;
          }
        });

        // 統計 AI 欄 (銷售相關問題件數)
        const keywords = ["(加盟)辦A給B", "盜辦", "特殊身份辦理爭議", "銷售相關問題", "辦門號換現金"];
        let aiCount = 0;
        jsonData.forEach(row => {
          const ai = row["AI"]?.toString();
          if (ai && keywords.some(k => ai.includes(k))) {
            aiCount++;
          }
        });

        // AM 欄：只保留「數字+門市名稱」，並做分類 (依分頁三 B欄對應)
        let storeData = {};
        jsonData.forEach(row => {
          let store = row["AM"]?.toString().trim();
          if (store) {
            // 只取「數字+名稱」
            store = store.replace("%", ""); 
            // 模擬分類 (這裡先假設依開頭代碼分區，實務上應該要讀取第3個分頁 B欄)
            let category = "其他";
            if (store.startsWith("180")) category = "北區";
            else if (store.startsWith("181")) category = "中區";
            else if (store.startsWith("182")) category = "南區";
            storeData[category] = (storeData[category] || 0) + 1;
          }
        });

        // === 產生成果檔 ===
        const wb = XLSX.utils.book_new();

        // Sheet1: 業務姓名統計
        const ws1 = XLSX.utils.json_to_sheet(Object.entries(salesCount).map(([k, v]) => ({ 業務姓名: k, 件數: v })));
        XLSX.utils.book_append_sheet(wb, ws1, "業務姓名統計");

        // Sheet2: AI 銷售相關問題
        const ws2 = XLSX.utils.json_to_sheet([{ "銷售相關問題件數": aiCount }]);
        XLSX.utils.book_append_sheet(wb, ws2, "銷售問題統計");

        // Sheet3: AM 分類統計
        const ws3 = XLSX.utils.json_to_sheet(Object.entries(storeData).map(([k, v]) => ({ 區域: k, 件數: v })));
        XLSX.utils.book_append_sheet(wb, ws3, "門市區域統計");

        // 轉檔並下載
        document.getElementById("download").style.display = "inline-block";
        document.getElementById("download").onclick = function() {
          XLSX.writeFile(wb, "工單目標檔.xlsx");
        };
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
