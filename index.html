
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>銷售工單統計工具</title>
    https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js
</head>
<body>
    <h2>銷售工單統計工具</h2>
    <input type="file" id="upload" accept=".xlsx" />
    <button onclick="downloadExcel()">下載統計結果</button>
    <div id="output"></div>

    <script>
        function findClosestField(target, fields) {
            let bestMatch = "";
            let highestScore = 0;
            fields.forEach(field => {
                const score = field.split("").filter(char => target.includes(char)).length;
                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = field;
                }
            });
            return bestMatch;
        }

        function downloadExcel() {
            if (!window.summaryData) {
                alert("請先上傳檔案並產生統計結果");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(window.summaryData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "統計結果");
            XLSX.writeFile(wb, "summary.xlsx");
        }

        document.getElementById('upload').addEventListener('change', function (e) {
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 2 });

                    if (json.length === 0) {
                        alert("檔案內容為空或格式錯誤");
                        return;
                    }

                    const allFields = Object.keys(json[0]);
                    const nameField = findClosestField("業務姓名", allFields);
                    const titleField = findClosestField("工單完整名稱", allFields);

                    if (!nameField || !titleField) {
                        alert("無法偵測到必要欄位，請確認檔案格式");
                        return;
                    }

                    const pattern = /銷售相關問題|\(加盟\)?辦A給B\/盜辦\/特殊身份辦理爭議|辦門號換現金/;
                    const summary = {};

                    json.forEach(row => {
                        const name = row[nameField];
                        const title = row[titleField];
                        if (!name) return;
                        if (!summary[name]) summary[name] = { '業務姓名': name, '登記總筆數': 0, '銷售類工單筆數': 0 };
                        summary[name]['登記總筆數']++;
                        if (title && pattern.test(title)) summary[name]['銷售類工單筆數']++;
                    });

                    const result = Object.values(summary);
                    window.summaryData = result;

                    let html = '<p>偵測欄位：<strong>' + nameField + '</strong> / <strong>' + titleField + '</strong></p>';
                    html += '<table border="1"><tr><th>業務姓名</th><th>登記總筆數</th><th>銷售類工單筆數</th></tr>';
                    result.forEach(row => {
                        html += `<tr><td>${row['業務姓名']}</td><td>${row['登記總筆數']}</td><td>${row['銷售類工單筆數']}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('output').innerHTML = html;
                } catch (err) {
                    alert("處理檔案時發生錯誤：" + err.message);
                }
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });
    </script>
</body>
</html>
