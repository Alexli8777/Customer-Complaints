<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Excel å·¥å–®è½‰æ›å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f8f9fa; }
    h1 { font-size: 22px; margin-bottom: 20px; }
    .upload-box { padding: 20px; border: 2px dashed #888; border-radius: 10px; background: #fff; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Excel å·¥å–®è½‰æ›å·¥å…·</h1>

  <div class="upload-box">
    <input type="file" id="upload" accept=".xlsx" />
    <p>è«‹ä¸Šå‚³ä¾†æºæª” (DefTicketExport...xlsx)</p>
  </div>

  <button id="download" style="display:none;">ä¸‹è¼‰æˆæœæª”</button>

  <script>
    document.getElementById("upload").addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        // é è¨­è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        // çµ±è¨ˆ X æ¬„ä½ (æ¥­å‹™å§“åä»¶æ•¸)
        let salesCount = {};
        jsonData.forEach(row => {
          const name = row["X"]?.toString().trim();
          if (name) {
            salesCount[name] = (salesCount[name] || 0) + 1;
          }
        });

        // çµ±è¨ˆ AI æ¬„ (éŠ·å”®ç›¸é—œå•é¡Œä»¶æ•¸)
        const keywords = ["(åŠ ç›Ÿ)è¾¦Açµ¦B", "ç›œè¾¦", "ç‰¹æ®Šèº«ä»½è¾¦ç†çˆ­è­°", "éŠ·å”®ç›¸é—œå•é¡Œ", "è¾¦é–€è™Ÿæ›ç¾é‡‘"];
        let aiCount = 0;
        jsonData.forEach(row => {
          const ai = row["AI"]?.toString();
          if (ai && keywords.some(k => ai.includes(k))) {
            aiCount++;
          }
        });

        // AM æ¬„ï¼šåªä¿ç•™ã€Œæ•¸å­—+é–€å¸‚åç¨±ã€ï¼Œä¸¦åšåˆ†é¡ (ä¾åˆ†é ä¸‰ Bæ¬„å°æ‡‰)
        let storeData = {};
        jsonData.forEach(row => {
          let store = row["AM"]?.toString().trim();
          if (store) {
            // åªå–ã€Œæ•¸å­—+åç¨±ã€
            store = store.replace("%", ""); 
            // æ¨¡æ“¬åˆ†é¡ (é€™è£¡å…ˆå‡è¨­ä¾é–‹é ­ä»£ç¢¼åˆ†å€ï¼Œå¯¦å‹™ä¸Šæ‡‰è©²è¦è®€å–ç¬¬3å€‹åˆ†é  Bæ¬„)
            let category = "å…¶ä»–";
            if (store.startsWith("180")) category = "åŒ—å€";
            else if (store.startsWith("181")) category = "ä¸­å€";
            else if (store.startsWith("182")) category = "å—å€";
            storeData[category] = (storeData[category] || 0) + 1;
          }
        });

        // === ç”¢ç”Ÿæˆæœæª” ===
        const wb = XLSX.utils.book_new();

        // Sheet1: æ¥­å‹™å§“åçµ±è¨ˆ
        const ws1 = XLSX.utils.json_to_sheet(Object.entries(salesCount).map(([k, v]) => ({ æ¥­å‹™å§“å: k, ä»¶æ•¸: v })));
        XLSX.utils.book_append_sheet(wb, ws1, "æ¥­å‹™å§“åçµ±è¨ˆ");

        // Sheet2: AI éŠ·å”®ç›¸é—œå•é¡Œ
        const ws2 = XLSX.utils.json_to_sheet([{ "éŠ·å”®ç›¸é—œå•é¡Œä»¶æ•¸": aiCount }]);
        XLSX.utils.book_append_sheet(wb, ws2, "éŠ·å”®å•é¡Œçµ±è¨ˆ");

        // Sheet3: AM åˆ†é¡çµ±è¨ˆ
        const ws3 = XLSX.utils.json_to_sheet(Object.entries(storeData).map(([k, v]) => ({ å€åŸŸ: k, ä»¶æ•¸: v })));
        XLSX.utils.book_append_sheet(wb, ws3, "é–€å¸‚å€åŸŸçµ±è¨ˆ");

        // è½‰æª”ä¸¦ä¸‹è¼‰
        document.getElementById("download").style.display = "inline-block";
        document.getElementById("download").onclick = function() {
          XLSX.writeFile(wb, "å·¥å–®ç›®æ¨™æª”.xlsx");
        };
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
