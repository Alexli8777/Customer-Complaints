<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Excel 工單轉換工具</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f8f9fa; }
    h1 { font-size: 22px; margin-bottom: 20px; }
    .upload-box { padding: 20px; border: 2px dashed #888; border-radius: 10px; background: #fff; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>📊 Excel 工單轉換工具</h1>

  <div class="upload-box">
    <input type="file" id="upload" accept=".xlsx" />
    <p>請上傳來源檔 (DefTicketExport...xlsx)</p>
  </div>

  <button id="download" style="display:none;">下載成果檔</button>

  <script>
    document.getElementById("upload").addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        // 讀取來源檔的第一個分頁
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "", header: 1 });

        if (jsonData.length === 0) {
          alert("來源檔是空的！");
          return;
        }

        // 標題列
        const headers = jsonData[0];
        const rows = jsonData.slice(1);

        // 自動找欄位名稱
        function findColumn(keywordList) {
          for (let i = 0; i < headers.length; i++) {
            if (keywordList.some(k => headers[i].toString().includes(k))) {
              return i;
            }
          }
          return -1;
        }

        const colX = findColumn(["業務", "X"]);     // 業務姓名
        const colAI = findColumn(["AI", "銷售", "問題"]); // AI 欄位
        const colAM = findColumn(["AM", "門市", "加盟"]); // AM 欄位

        if (colX === -1 || colAI === -1 || colAM === -1) {
          alert("找不到必要的欄位（業務姓名 / AI / AM）");
          return;
        }

        // 銷售相關問題關鍵字
        const keywords = ["(加盟)辦A給B", "盜辦", "特殊身份辦理爭議", "銷售相關問題", "辦門號換現金"];

        // 分頁一：依業務姓名統計
        let salesStats = {};
        rows.forEach(r => {
          const name = r[colX]?.toString().trim();
          const ai = r[colAI]?.toString().trim();

          if (!name) return;

          if (!salesStats[name]) {
            salesStats[name] = { total: 0, issue: 0 };
          }

          salesStats[name].total++;
          if (ai && keywords.some(k => ai.includes(k))) {
            salesStats[name].issue++;
          }
        });

        const ws1Data = Object.entries(salesStats).map(([name, obj]) => ({
          "業務姓名": name,
          "工單總筆數": obj.total,
          "銷售相關問題件數": obj.issue
        }));

        // 分頁二：依門市統計
        let storeStats = {};
        rows.forEach(r => {
          let am = r[colAM]?.toString().trim();
          const ai = r[colAI]?.toString().trim();

          if (!am || am.length < 8) return;

          const code = am.substring(0, 7); // 前7碼
          const name = am.substring(7).trim(); // 後面名稱
          const key = code + " " + name;

          if (!storeStats[key]) {
            storeStats[key] = { code, name, total: 0, issue: 0 };
          }

          storeStats[key].total++;
          if (ai && keywords.some(k => ai.includes(k))) {
            storeStats[key].issue++;
          }
        });

        const ws2Data = Object.values(storeStats).map(obj => ({
          "7位數代碼": obj.code,
          "加盟門市名稱": obj.name,
          "工單總筆數": obj.total,
          "銷售相關問題件數": obj.issue
        }));

        // === 產生成果檔 ===
        const wb = XLSX.utils.book_new();

        // Sheet1: 業務統計
        const ws1 = XLSX.utils.json_to_sheet(ws1Data);
        XLSX.utils.book_append_sheet(wb, ws1, "業務統計");

        // Sheet2: 門市統計
        const ws2 = XLSX.utils.json_to_sheet(ws2Data);
        XLSX.utils.book_append_sheet(wb, ws2, "門市統計");

        // 下載按鈕
        document.getElementById("download").style.display = "inline-block";
        document.getElementById("download").onclick = function() {
          XLSX.writeFile(wb, "工單目標檔.xlsx");
        };
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
