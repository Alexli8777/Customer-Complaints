<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>銷售工單統計工具</title>
    https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js
</head>
<body>
    <h2>銷售工單統計工具</h2>
    <input type="file" id="upload" accept=".xlsx" />
    <button onclick="downloadExcel()">下載統計結果</button>
    <div id="output"></div>

    <script>
        function downloadExcel() {
            if (!window.summaryData) {
                alert("請先上傳檔案並產生統計結果");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(window.summaryData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "統計結果");
            XLSX.writeFile(wb, "summary.xlsx");
        }

        document.getElementById('upload').addEventListener('change', function (e) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 2 });

                const pattern = /銷售相關問題|\(加盟\)?辦A給B\/盜辦\/特殊身份辦理爭議|辦門號換現金/;
                const summary = {};

                json.forEach(row => {
                    const name = row['業務姓名'];
                    title = row['工單完整名稱'];
                    if (!name) return;
                    if (!summary[name]) summary[name] = { '業務姓名': name, '登記總筆數': 0, '銷售類工單筆數': 0 };
                    summary[name]['登記總筆數']++;
                    if (pattern.test(title)) summary[name]['銷售類工單筆數']++;
                });

                const result = Object.values(summary);
                window.summaryData = result;

                let html = '<table border="1"><tr><th>業務姓名</th><th>登記總筆數</th><th>銷售類工單筆數</th></tr>';
                result.forEach(row => {
                    html += `<tr><td>${row['業務姓名']}</td><td>${row['登記總筆數']}</td><td>${row['銷售類工單筆數']}</td></tr>`;
                });
                html += '</table>';
                document.getElementById('output').innerHTML = html;
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });
    </script>
</body>
</html>
